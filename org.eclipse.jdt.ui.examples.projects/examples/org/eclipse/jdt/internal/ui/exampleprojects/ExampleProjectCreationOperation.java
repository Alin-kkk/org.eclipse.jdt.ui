/* * (c) Copyright IBM Corp. 2000, 2001. * All Rights Reserved. */package org.eclipse.jdt.internal.ui.exampleprojects;import java.io.File;import java.io.IOException;import java.lang.reflect.InvocationTargetException;import java.net.URL;import java.util.ArrayList;import java.util.zip.ZipFile;import org.eclipse.swt.widgets.Shell;import org.eclipse.core.resources.IProject;import org.eclipse.core.resources.IResource;import org.eclipse.core.runtime.IConfigurationElement;import org.eclipse.core.runtime.IPath;import org.eclipse.core.runtime.IProgressMonitor;import org.eclipse.core.runtime.NullProgressMonitor;import org.eclipse.core.runtime.Path;import org.eclipse.core.runtime.Platform;import org.eclipse.core.runtime.SubProgressMonitor;import org.eclipse.jface.dialogs.Dialog;import org.eclipse.jface.dialogs.IDialogConstants;import org.eclipse.jface.dialogs.MessageDialog;import org.eclipse.jface.operation.IRunnableWithProgress;import org.eclipse.ui.dialogs.IOverwriteQuery;import org.eclipse.ui.wizards.datatransfer.ImportOperation;import org.eclipse.ui.wizards.datatransfer.ZipFileStructureProvider;import org.eclipse.jdt.core.IClasspathEntry;import org.eclipse.jdt.core.IJavaElement;import org.eclipse.jdt.core.JavaCore;import org.eclipse.jdt.core.JavaModelException;import org.eclipse.jdt.ui.wizards.NewJavaProjectWizardPage;public class ExampleProjectCreationOperation implements IRunnableWithProgress {		private static final String OP_DESC= "ExampleProjectCreationOperation.op_desc";	private static final String OVERWRITE_PREFIX= "ExampleProjectCreationOperation.overwritequery.";		private NewJavaProjectWizardPage fJavaProjectPage;	private IProject fProject;	private IResource fResourceToReveal;		private IConfigurationElement fConfigElement;		private Shell fShell;		/**	 * Constructor for CreateJUnitProjectOperation	 */	public ExampleProjectCreationOperation(Shell shell, IProject currProject, IConfigurationElement configElement, NewJavaProjectWizardPage javaProjectPage) {		fJavaProjectPage= javaProjectPage;		fProject= currProject;		fConfigElement= configElement;		fShell= shell;	}		/**	 * @see IRunnableWithProgress#run(IProgressMonitor)	 */	public void run(IProgressMonitor monitor) throws InvocationTargetException, InterruptedException {		if (monitor == null) {			monitor= new NullProgressMonitor();		}				IConfigurationElement desc;		IConfigurationElement[] children = fConfigElement.getChildren("projectsetup");		if (children.length == 1) {			desc= children[0];		} else {			throw new InvocationTargetException(new Exception("descriptor must contain exactly on projectsetup tag"));		}		IPath outputFolder;		String output= desc.getAttribute("output");		if (output == null || output.length() == 0) {			outputFolder= fProject.getFullPath();		} else {			outputFolder= new Path(output);		}		String jre= desc.getAttribute("jre");		boolean addJRE= "true".equals(jre);				ArrayList classPathEntries= new ArrayList();		ArrayList importPaths= new ArrayList();				children = desc.getChildren("src");		for (int i= 0; i < children.length; i++) {			IConfigurationElement curr= children[i];			IPath path;			String name= curr.getAttribute("path");			if (name == null || name.length() == 0) {				path= fProject.getFullPath();			} else {				path= fProject.getFolder(name).getFullPath();			}			classPathEntries.add(JavaCore.newSourceEntry(path));			String importPath= curr.getAttribute("import");			if (importPath == null) {				importPath= "";				ExampleProjectsPlugin.log("projectsetup descriptor: path missing");			}			importPaths.add(importPath);		}				fJavaProjectPage.setDefaultOutputFolder(outputFolder);		IClasspathEntry[] entries= new IClasspathEntry[classPathEntries.size()];		classPathEntries.toArray(entries);		fJavaProjectPage.setDefaultClassPath(entries, addJRE);						monitor.beginTask(ExampleProjectsPlugin.getResourceString(OP_DESC), 3 + entries.length);				try {				// create the project			fJavaProjectPage.getRunnable().run(new SubProgressMonitor(monitor, 3));						// import			for (int i= 0; i < entries.length; i++) {				IPath destPath= entries[i].getPath();				String importPath= (String)importPaths.get(i);				if (importPath.length() > 0) {					ZipFile zipFile= new ZipFile(getFileFromPluginDir(importPath));					importFilesFromZip(zipFile, destPath, new SubProgressMonitor(monitor, 1));				}			}					fResourceToReveal= fProject;			String reveal= desc.getAttribute("open");			if (reveal != null && reveal.length() > 0) {				IJavaElement elem= fJavaProjectPage.getNewJavaProject().findElement(new Path(reveal));				if (elem != null) {					fResourceToReveal= elem.getUnderlyingResource();				}			}		} catch (IOException e) {			throw new InvocationTargetException(e);		} catch (JavaModelException e) {			throw new InvocationTargetException(e);					} finally {			monitor.done();		}	}				public IResource getResourceToReveal() {		return fResourceToReveal;	}		private File getFileFromPluginDir(String pluginRelativePath) throws IOException {		URL starterURL= new URL(ExampleProjectsPlugin.getDefault().getDescriptor().getInstallURL(), pluginRelativePath);		return new File(Platform.asLocalURL(starterURL).getFile());	}		private void importFilesFromZip(ZipFile srcZipFile, IPath destPath, IProgressMonitor monitor) throws InvocationTargetException, InterruptedException {				ZipFileStructureProvider structureProvider=	new ZipFileStructureProvider(srcZipFile);		ImportOperation op= new ImportOperation(destPath, structureProvider.getRoot(), structureProvider, new ImportOverwriteQuery());		op.run(monitor);	}		public class ImportOverwriteQuery implements IOverwriteQuery {			public String queryOverwrite(String file) {			String[] returnCodes= {YES, NO, ALL, CANCEL};			int returnVal= openDialog(file);			return returnVal < 0 ? CANCEL : returnCodes[returnVal];		}					private int openDialog(final String file) {			final int[] result= { Dialog.CANCEL };			fShell.getDisplay().syncExec(new Runnable() {				public void run() {					String title= ExampleProjectsPlugin.getResourceString(OVERWRITE_PREFIX + "title");					String msg= ExampleProjectsPlugin.getFormattedString(OVERWRITE_PREFIX + "message", file);					String[] options= {IDialogConstants.YES_LABEL, IDialogConstants.NO_LABEL, IDialogConstants.YES_TO_ALL_LABEL, IDialogConstants.CANCEL_LABEL};					MessageDialog dialog= new MessageDialog(fShell, title, null, msg, MessageDialog.QUESTION, options, 0);					result[0]= dialog.open();				}			});			return result[0];		}	}		}